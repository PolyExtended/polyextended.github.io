<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Featured List</title>
    
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Materialize Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h4>Twitch Featured List</h4>
        <ul class="collection" id="featuredList"></ul>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        const clientId = '2oag632o0mp6n85h3mismr2ocsa1jip';
        const accessToken = '62ly1aqjnymr30sn6yga5xpxuo4yi9';
        const twitchCategory = 'grandtheftautov';
        let isRendered = false;

        async function getTwitchStreams() {
            try {
                const response = await fetch(`https://api.twitch.tv/helix/streams?game_id=${twitchCategory}`, {
                    method: 'GET',
                    headers: {
                        'Client-ID': clientId,
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('Error fetching Twitch API:', error);
                return null;
            }
        }

        async function getFallbackUsernames() {
            try {
                const response = await fetch('https://polyextended.github.io/lookup/twitch.json');
                const data = await response.json();
                return data.fallbackUsernames || [];
            } catch (error) {
                console.error('Error fetching fallback usernames:', error);
                return [];
            }
        }

        async function getBannedUsers() {
            const bannedResponse = await fetch('https://polyextended.github.io/lookup/banned.json');
            const bannedData = await bannedResponse.json();
            return bannedData.Users;
        }

        async function isUserBanned(username) {
            const bannedUsers = await getBannedUsers();
            return bannedUsers.includes(username);
        }

        async function renderFeaturedList() {
            if (isRendered) {
                return;
            }

            let streams = await getTwitchStreams();
            const featuredList = document.getElementById('featuredList');

            if (!streams) {
                // Use fallback list from twitch.json
                const fallbackUsernames = await getFallbackUsernames();
                streams = fallbackUsernames.map(username => ({ user_name: username }));
            }

            if (streams.length > 0) {
                // Select a random featured streamer
                const randomIndex = Math.floor(Math.random() * streams.length);
                const randomStreamer = streams[randomIndex];
                
                const username = randomStreamer.user_name;

                if (await isUserBanned(username)) {
                    console.log(`${username} is banned and will not be featured.`);
                    return;
                }

                const listItem = document.createElement('li');
                listItem.classList.add('collection-item');
                listItem.innerHTML = `<span class="title">${username}</span><p>${randomStreamer.title || ''}</p>`;
                featuredList.appendChild(listItem);

                // Save the username to localStorage
                saveUsernameToLocalStorage(username);

                // Add the username to twitch.json
                addUsernameToTwitchJson(username);

                isRendered = true;
            }
        }

        function saveUsernameToLocalStorage(username) {
            const savedUsernames = JSON.parse(localStorage.getItem('twitchUsernames')) || [];
            savedUsernames.push(username);
            localStorage.setItem('twitchUsernames', JSON.stringify(savedUsernames));
        }

        function addUsernameToTwitchJson(username) {
            // Fetch the existing data from twitch.json
            fetch('https://polyextended.github.io/lookup/twitch.json')
                .then(response => response.json())
                .then(data => {
                    // Add the new username to the array
                    data.fallbackUsernames = data.fallbackUsernames || [];
                    data.fallbackUsernames.push(username);

                    // Update twitch.json with the new data
                    fetch('https://polyextended.github.io/lookup/twitch.json', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(updatedData => console.log('Updated twitch.json:', updatedData))
                    .catch(error => console.error('Error updating twitch.json:', error));
                })
                .catch(error => console.error('Error fetching twitch.json:', error));
        }

        document.addEventListener('DOMContentLoaded', function () {
            renderFeaturedList();
        });
    </script>
</body>
</html>
